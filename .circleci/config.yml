version: 2.1

executors:
  jdk8:
    docker:
      - image: circleci/openjdk:8
    working_directory: ~/work
    environment:
      TZ: Asia/Tokyo

jobs:
  run:
    executor: jdk8
    steps:
      - checkout
      - run: mvn package -V -B
      - run: mkdir -pv dist && cp -v target/*.jar dist
      - store_artifacts: { path: 'dist' }
  deploy:
    executor: jdk8
    steps:
      - checkout
      - add_ssh_keys: { fingerprints: ['da:37:83:1c:a0:b4:5d:de:75:a7:64:c4:25:24:91:9a'] }
      - run: git clone git@github.com:AzisabaNetwork/mvn-repo.git
      - run: mvn deploy -DaltDeploymentRepository=local::default::file://mvn-repo -V -B
      - run: git config --global user.email 'null@azisaba.net'
      - run: git config --global user.name mvn-repo
      - run: cd mvn-repo && git add -A && git commit -m "Deploy @ $(date)" && git push origin master

workflows:
  version: 2
  commit: { jobs: [run, deploy] }
